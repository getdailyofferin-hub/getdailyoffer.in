<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YY5E7YNSZ0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-YY5E7YNSZ0');
  </script>
  <!-- Google tag (gtag.js) end-->
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Add Offer - GetDailyOffer</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="logo">
      <a href="index.html">
        <img src="assets/getdailyoffer.jpg" alt="Logo" width="60" height="60">
      </a>
    </div>
    <div>
      <p style="font-weight:bold;color:orange;font-size:22px;margin:0">G e t D a i l y O f f e r . i n</p>
      <p style="font-size:14px;color:#333;margin:0">Add a new offer</p>
    </div>
  </header>
  
  <main class="container">
    <h2>Add New Offer</h2>
    <form id="addOfferForm">
      <label>Shop Name</label>
      <input type="text" id="shop" required>
  
      <label>Offer Title</label>
      <input type="text" id="title" required>
  
      <label>Category</label>
      <select id="category" required>
        <option value="cloth">Cloth</option>
        <option value="food">Food</option>
        <option value="electronics">Electronics</option>
        <option value="service">Service</option>
        <option value="spices">Spices</option>
      </select>
  
      <label>Price</label>
      <input type="text" id="price" placeholder="e.g. ₹299 onwards" required>
      
      <label>Description</label>
      <textarea id="description" rows="3" required></textarea>
  
      <label>Image</label>
      <input type="file" id="imgFile" accept="image/*" required>
      <img id="imgPreview" src="" alt="Preview" style="display:none; max-width:100%; margin-top:10px; border-radius:8px;">
  
      <label>Expiry Date</label>
      <input type="date" id="expiryDate" required>
      
      <label>Location</label>
      <input type="text" id="location" required>
  
      <button type="submit" class="btn get" style="margin-top:12px;">Submit Offer for Review</button>
    </form>
    <div id="msg" style="margin-top:12px;"></div>
    <div id="loading" style="display:none; text-align:center; margin-top:20px;">
      <p>Uploading... Please wait</p>
    </div>
  </main>
  
  <script src="supabase-config.js"></script>
  <script>
  const form = document.getElementById('addOfferForm');
  const msg = document.getElementById('msg');
  const imgFile = document.getElementById('imgFile');
  const imgPreview = document.getElementById('imgPreview');
  const loading = document.getElementById('loading');
  
  // Preview image
  imgFile.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
          imgPreview.src = reader.result;
          imgPreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
  });
  
  // Submit form
  form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const file = imgFile.files[0];
      if (!file) {
          msg.innerHTML = '<span style="color:red">Please select an image.</span>';
          return;
      }
      
      // Show loading
      loading.style.display = 'block';
      msg.innerHTML = '';
      
      try {
          // Upload image to temp_images bucket
          const fileName = `${Date.now()}_${file.name}`;
          const { data: uploadData, error: uploadError } = await supabase.storage
              .from('temp_images')
              .upload(fileName, file);
          
          if (uploadError) throw uploadError;
          
          // Get public URL
          const { data: urlData } = supabase.storage
              .from('temp_images')
              .getPublicUrl(fileName);
          
          // Insert into temp table
          const { data, error } = await supabase
              .from('temp')
              .insert([{
                  shop_name: document.getElementById('shop').value,
                  offer_title: document.getElementById('title').value,
                  category: document.getElementById('category').value,
                  price: document.getElementById('price').value,
                  description: document.getElementById('description').value,
                  image_link: urlData.publicUrl,
                  expiry_date: document.getElementById('expiryDate').value,
                  location: document.getElementById('location').value
              }]);
          
          if (error) throw error;
          
          msg.innerHTML = '<span style="color:green">✓ Offer submitted successfully! It will be reviewed by admin.</span>';
          form.reset();
          imgPreview.style.display = 'none';
          
      } catch (error) {
          console.error('Error:', error);
          msg.innerHTML = `<span style="color:red">Error: ${error.message}</span>`;
      } finally {
          loading.style.display = 'none';
      }
  });
  </script>
</body>
</html>